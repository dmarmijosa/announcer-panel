<div class="p-4">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Biblioteca de Audio</h1>
    <label class="btn btn-primary">
      Subir Nueva Pista
      <input
        type="file"
        class="hidden"
        (change)="onFileSelected($event)"
        accept="audio/mpeg"
      />
    </label>
  </div>

  @if (uploadError()) {
  <div role="alert" class="alert alert-error mb-4">
    <span>{{ uploadError() }}</span>
  </div>
  }

  <div class="overflow-x-auto">
    <table class="table w-full">
      <thead>
        <tr>
          <!-- Nueva columna para el botón de Play -->
          <th></th>
          <th>Título</th>
          <th>Artista</th>
          <th>Subido el</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @if (isLoading()) {
        <tr>
          <td colspan="5" class="text-center">
            <span class="loading loading-lg"></span>
          </td>
        </tr>
        } @for (track of audioService.audioFiles(); track track.id) {
        <tr>
          <!-- Botón de Play/Pause -->
          <td>
            <button
              class="btn btn-ghost btn-circle"
              (click)="togglePlay(track)"
            >
              @if (playerService.currentlyPlaying()?.id === track.id) {
              <!-- Icono de Pausa -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              } @else {
              <!-- Icono de Play -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              }
            </button>
          </td>
          <td>{{ track.title }}</td>
          <td>{{ track.artist }}</td>
          <td>{{ track.uploadedAt | date : "dd/MM/yyyy" }}</td>
          <td class="space-x-2">
            <button class="btn btn-sm btn-ghost" (click)="openEditModal(track)">
              Editar
            </button>
            <button
              class="btn btn-sm btn-error btn-ghost"
              (click)="deleteTrack(track.id)"
            >
              Borrar
            </button>
          </td>
        </tr>
        } @empty { @if (!isLoading()) {
        <tr>
          <td colspan="5" class="text-center">
            No hay archivos en la biblioteca. ¡Sube el primero!
          </td>
        </tr>
        } }
      </tbody>
    </table>
  </div>
</div>

<!-- MODAL DE EDICIÓN -->
<dialog class="modal" [class.modal-open]="editingTrack() !== null">
  <div class="modal-box">
    @if (editingTrack(); as track) {
    <h3 class="font-bold text-lg">Editando: {{ track.originalName }}</h3>

    <form [formGroup]="editForm" (ngSubmit)="onUpdateSubmit()">
      <div class="form-control w-full mt-4">
        <label class="label"><span class="label-text">Título</span></label>
        <input
          type="text"
          formControlName="title"
          class="input input-bordered w-full"
        />
      </div>
      <div class="form-control w-full mt-4">
        <label class="label"><span class="label-text">Artista</span></label>
        <input
          type="text"
          formControlName="artist"
          class="input input-bordered w-full"
        />
      </div>
      <div class="modal-action">
        <button type="button" class="btn" (click)="closeEditModal()">
          Cancelar
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="editForm.invalid"
        >
          Guardar Cambios
        </button>
      </div>
    </form>
    }
  </div>
</dialog>
